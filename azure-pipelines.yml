trigger:
- master

pool:
  vmImage: ubuntu-latest

variables:
  buildConfiguration: 'Release'
  webAppName: 'webappname123'

stages:

# ------------------------------------------------------
# Build Stage
# ------------------------------------------------------
- stage: Build
  displayName: "Build Stage"
  jobs:
  - job: BuildJob
    displayName: "Build .NET Project"
    steps:
    - task: UseDotNet@2
      inputs:
        packageType: 'sdk'
        version: '8.x' # adjust if needed

    - script: dotnet build --configuration $(buildConfiguration)
      displayName: "dotnet build $(buildConfiguration)"

    - script: dotnet publish -c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)
      displayName: "Publish Build Output"

    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'


# ------------------------------------------------------
# Deploy Stage
# ------------------------------------------------------
- stage: Deploy
  displayName: "Deploy Stage"
  dependsOn: Build
  jobs:
  - deployment: DeployWebApp
    displayName: "Deploy to Azure Web App"
    environment: "production"
    strategy:
      runOnce:
        deploy:
          steps:
          - download: current
            artifact: drop

          - task: AzureWebApp@1
            displayName: "Deploy to $(webAppName)"
            inputs:
              azureSubscription: 'myserviceconnection'  # 
              appType: 'webApp'                    # change to webApp if Windows App Service
              appName: '$(webAppName)'
              package: '$(Pipeline.Workspace)/drop'
